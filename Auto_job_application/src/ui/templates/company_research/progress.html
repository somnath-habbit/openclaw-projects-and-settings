<!DOCTYPE html>
<html>
<head>
    <title>Researching... - AutoJob</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; max-width: 800px; }
        .spinner-container { text-align: center; padding: 40px 0; }
        .progress { height: 30px; }
        .progress-bar { font-size: 1rem; }
        #status-message { min-height: 100px; }
    </style>
</head>

<body>
    <div class="container">
        <div class="card shadow-lg">
            <div class="card-body p-5">
                <div class="spinner-container mb-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <h3 class="text-center mb-4">Researching {{ company_name }}...</h3>

                <!-- Progress Bar -->
                <div class="progress mb-4">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>

                <!-- Status Messages -->
                <div id="status-message" class="border rounded p-3 bg-light" style="font-family: monospace; font-size: 0.9rem;">
                    <div class="text-muted">Starting research...</div>
                </div>

                <div class="alert alert-info mt-4">
                    <strong>⏱️ Please wait...</strong> Research typically takes 5-10 minutes. Don't close this window.
                </div>
            </div>
        </div>
    </div>

    <script>
        const taskId = "{{ task_id }}";
        const statusMessages = [];

        function updateProgress() {
            fetch(`/company-research/api/progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const progressPct = Math.round(data.progress * 100);
                    const progressBar = document.getElementById('progress-bar');
                    progressBar.style.width = progressPct + '%';
                    progressBar.textContent = progressPct + '%';

                    // Add message to log
                    if (data.message && !statusMessages.includes(data.message)) {
                        statusMessages.push(data.message);
                        const messageDiv = document.getElementById('status-message');
                        const newMessage = document.createElement('div');
                        newMessage.textContent = '• ' + data.message;
                        newMessage.className = 'mb-1';
                        messageDiv.appendChild(newMessage);

                        // Scroll to bottom
                        messageDiv.scrollTop = messageDiv.scrollHeight;
                    }

                    // Check if complete
                    if (data.status === 'complete') {
                        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                        progressBar.classList.add('bg-success');

                        // Redirect to report
                        setTimeout(() => {
                            window.location.href = `/company-research/report/${data.company_id}`;
                        }, 1000);
                    } else if (data.status === 'error') {
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-danger');
                        document.getElementById('status-message').innerHTML +=
                            `<div class="text-danger mt-2"><strong>Error:</strong> ${data.error}</div>`;
                    } else {
                        // Still running, poll again
                        setTimeout(updateProgress, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    setTimeout(updateProgress, 2000);
                });
        }

        // Start polling
        setTimeout(updateProgress, 1000);
    </script>
</body>
</html>
